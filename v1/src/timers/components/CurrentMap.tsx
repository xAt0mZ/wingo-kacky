import { filter } from 'lodash';
import { useMemo } from 'react';
import { Spinner, ToggleButton } from 'react-bootstrap';

import { getVariant } from '../../clips/components/MapButton';
import { Star } from '../../components/icons/Star';
import { VStack } from '../../components/VStack';
import { useGlobalState } from '../../hooks/useGlobalState';
import { Edition, Streamer } from '../../models/consts';
import { useSelectedMap } from '../hooks/useSelectedMap';

type Props = {
  id: number;
  isLoading: boolean;
  current?: number;
  minutes: number;
  seconds: number;
}

export function CurrentMap({ id, isLoading, current, minutes, seconds }: Props) {
  const { allMaps } = useGlobalState();
  const { selectedMap, setSelectedMap } = useSelectedMap();

  const currentMap = useMemo(() => {
    const editionMaps = filter(allMaps, {edition: Edition.K7, streamer: Streamer.WINGO});
    return editionMaps.find((m) => m.id === current);
  }, [allMaps, current])

  return (
    <VStack className="justify-content-center align-items-center gap-2">
      <>Serveur {id}</>
      {isLoading &&
        <Spinner animation="border" role="status">
          <span className="visually-hidden">Loading...</span>
        </Spinner>
      }
      {!isLoading && currentMap &&
        <>
          <ToggleButton
            value=""
            id={`server-${id}-${currentMap.id}`}
            key={currentMap.id}
            variant={getVariant(currentMap)}
            className="mx-1 fw-bolder"
            type='checkbox'
            checked={currentMap.id === selectedMap?.id}
            onClick={() => setSelectedMap(currentMap)}
            style={{ position: 'relative' }}
          >
            {currentMap.id}
            {currentMap.fav && <Star />}
          </ToggleButton>
          <Timer minutes={minutes} seconds={seconds} />
        </>}
    </VStack>
  );
}

function Timer({ minutes, seconds }: { minutes: number, seconds: number }) {
  return (
    <div className="hstack justify-content-center">
      <Digit value={minutes} /> : <Digit value={seconds} />
    </div>
  )
}

function Digit({ value }: { value: number }) {
  const leftDigit = value >= 10 ? value.toString()[0] : '0';
  const rightDigit = value >= 10 ? value.toString()[1] : value.toString();
  return (
    <>
      <span>{leftDigit}</span><span>{rightDigit}</span>
    </>
  );
}